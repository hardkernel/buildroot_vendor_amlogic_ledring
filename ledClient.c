/*
 * This file is part of ledring.
 * Copyright (c) amlogic 2017
 * All rights reserved.
 * author:renjun.xu@amlogic.com
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software.
 *
 */
#include <stdio.h>
#include <mqueue.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <errno.h>
#include <sys/types.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <string.h>
#ifdef _USE_LEDRING_DAEMON
#include "ledClient.h"
#include "qipc.h"
#endif

#ifdef _USE_LEDRING_DAEMON
static messageID mID;
#else
#define DEV_NAME "/dev/ledring"
#define DEFAULT_SPEED 230
#define CMD_LEDRING_ARG   0x100001
int fp;
struct leds{
    int num;   /*the number of leds*/
    int rgbflag; /*led color flag. 0: Single color  1: rgb colour*/
    int speed; /*the speed of move. [0~N] ms*/
    int time; /*the timeout of move. [0 ~ N] s . 0s mean close timeout*/
    int style[6][6]; /*style data*/
} styleData = {6, 0, DEFAULT_SPEED, 0, {0}};

/*
    data: led1 led2 led3 led4 led5 led6 x x
    on  :  1    1    1    1    1    1
    off :  0    0    0    0    0    0
*/
int m_style[7][6][6] = {
    {
       /*led1  led2  led3  led4  led5  led6*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state1*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state2*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state3*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state4*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state5*/
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},/*state6*/
    },
    {
        {0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x01, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x01, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x00, 0x01, 0x00, 0x00},
        {0x00, 0x00, 0x00, 0x00, 0x01, 0x00},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x01},
    },
    {
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    },
    {
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
    },
    {
        {0x01, 0x00, 0x01, 0x00, 0x01, 0x00},
        {0x00, 0x01, 0x00, 0x01, 0x00, 0x01},
        {0x01, 0x00, 0x01, 0x00, 0x01, 0x00},
        {0x00, 0x01, 0x00, 0x01, 0x00, 0x01},
        {0x01, 0x00, 0x01, 0x00, 0x01, 0x00},
        {0x00, 0x01, 0x00, 0x01, 0x00, 0x01},
    },
    {
        {0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x01, 0x01, 0x00, 0x00, 0x00, 0x00},
        {0x01, 0x01, 0x01, 0x00, 0x00, 0x00},
        {0x01, 0x01, 0x01, 0x01, 0x00, 0x00},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x00},
        {0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
    },
    {
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x01},
        {0x00, 0x00, 0x00, 0x00, 0x01, 0x00},
        {0x00, 0x00, 0x00, 0x01, 0x00, 0x00},
        {0x00, 0x00, 0x01, 0x00, 0x00, 0x00},
        {0x00, 0x01, 0x00, 0x00, 0x00, 0x00},
        {0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
    },
};
#endif

int ledInit(void){
#ifdef _USE_LEDRING_DAEMON
    mID= mq_open(SLN_IPC_MQ_NAME, O_WRONLY);
    if (mID < 0)
        return -1;
#else
    fp=open(DEV_NAME, O_RDWR);
    if (fp > 0) {
    } else {
        printf("open \"%s\" fail!\n",DEV_NAME);
        return -1;
    }
#endif
    return 0;
}

int ledShow(int num, int rgbflag, int speed, int time, int style){
    int ret = 0;
#ifdef _USE_LEDRING_DAEMON
    if (mq_send(mID, (const char*)state, sizeof(struct leds), 0) < 0) {
        printf("send message err!\n");
        return -1;
    }
#else
    if ((style > (sizeof(m_style)/sizeof(m_style[0])-1)) || (style <0)) {
        printf("This style is not supported, please check!\n");
        return -1;
    }

    memcpy((char*)&styleData.style, (char*)&m_style[style], sizeof(styleData.style));

    styleData.num = num;
    styleData.speed = speed;
    styleData.time = time;
    styleData.rgbflag = rgbflag;
    ret = ioctl(fp,CMD_LEDRING_ARG,&styleData);
#endif
    return 0;
}

int ledRelease(void) {
    int ret = 0;
#ifdef _USE_LEDRING_DAEMON
    ret = mq_close(mID);
    if (ret != 0) {
        printf("send message release err!\n");
        return -1;
    }
#else
    ret = close(fp);
    if (ret < 0) return -1;
#endif
    return 0;
}
